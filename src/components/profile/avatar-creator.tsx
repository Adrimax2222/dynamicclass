"use client";

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import type { User } from "@/lib/types";
import { cn } from "@/lib/utils";
import { PawPrint, Gamepad2, Ghost, Palmtree, Rocket, Pizza, Cat, Heart } from "lucide-react";

const SHOP_AVATARS = [
    { id: 'paw', icon: PawPrint },
    { id: 'gamepad', icon: Gamepad2 },
    { id: 'ghost', icon: Ghost },
    { id: 'palmtree', icon: Palmtree },
    { id: 'rocket', icon: Rocket },
    { id: 'pizza', icon: Pizza },
    { id: 'cat', icon: Cat },
    { id: 'heart', icon: Heart },
];

const shopAvatarMap = new Map(SHOP_AVATARS.map(item => [item.id, item]));

function SantaHat() {
    return (
        <svg xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" width="512" zoomAndPan="magnify" viewBox="0 0 384 383.999986" height="512" preserveAspectRatio="xMidYMid" version="1.0"
            className="absolute -top-[50%] -right-[40%] w-[120%] h-[120%] transform rotate-[15deg] z-10 pointer-events-none"
            style={{ filter: 'drop-shadow(2px 2px 2px rgba(0,0,0,0.2))' }}
        >
            <defs><clipPath id="13dd563cf7"><path d="M 38.398438 78.617188 L 345.898438 78.617188 L 345.898438 305.117188 L 38.398438 305.117188 Z M 38.398438 78.617188 " clipRule="nonzero"/></clipPath></defs><g clipPath="url(#13dd563cf7)"><path fill="#0b0a06" d="M 268.265625 213.375 C 266.941406 225.953125 264.011719 237.097656 257.148438 246.871094 C 256.15625 248.285156 256.394531 249.511719 257.03125 251.039062 C 261.191406 260.996094 258.742188 269.433594 250.621094 276.238281 C 248.457031 278.058594 247.523438 280.105469 246.800781 282.753906 C 243.289062 295.65625 230.90625 302.707031 217.839844 299.457031 C 209.832031 297.476562 202.992188 293.136719 196.386719 288.4375 C 170.8125 270.207031 145.371094 251.726562 117.445312 237.148438 C 97.113281 226.542969 76.351562 216.746094 55.765625 206.617188 C 47.339844 202.476562 40.339844 197.179688 38.9375 187.027344 C 37.746094 178.402344 40.710938 171.59375 47.726562 166.484375 C 49.3125 165.332031 51.074219 164.789062 51.410156 162.089844 C 53.542969 144.90625 63.96875 137.066406 81.421875 139.371094 C 83.632812 139.664062 85.222656 139.882812 86.753906 137.832031 C 105.222656 113.144531 130.792969 98.4375 158.863281 87.554688 C 180.480469 79.167969 202.933594 75.835938 225.839844 81.273438 C 251.640625 87.410156 270.765625 103.4375 285.996094 124.359375 C 302.113281 146.496094 310.058594 171.714844 312.722656 198.746094 C 313.921875 210.917969 314.535156 223.132812 313.601562 235.316406 C 313.289062 239.410156 314.21875 240.679688 318.171875 241.539062 C 331.152344 244.355469 340.023438 252.273438 344.050781 264.921875 C 349.855469 283.09375 339.109375 299.757812 319.058594 304.238281 C 299.960938 308.5 280.980469 296.765625 277.335938 278.277344 C 275.195312 267.433594 278.566406 258.078125 286.582031 250.75 C 289.683594 247.914062 290.003906 245.5 288.808594 241.949219 C 284.996094 230.660156 279.175781 220.839844 268.265625 213.375 Z M 268.265625 213.375 " fillOpacity="1" fillRule="nonzero"/></g><path fill="#dd3a39" d="M 306.230469 221.925781 C 306.230469 226.808594 305.878906 231.730469 306.328125 236.574219 C 306.808594 241.835938 302.886719 241.53125 299.847656 242.519531 C 296.027344 243.742188 296.003906 240.632812 295.359375 238.421875 C 291.515625 225.203125 283.355469 215.167969 272.203125 207.472656 C 269.726562 205.761719 268.484375 204.046875 268.691406 201.085938 C 268.996094 196.738281 268.117188 192.480469 267.367188 188.230469 C 267.035156 186.351562 266.167969 184.265625 263.902344 184.480469 C 261.273438 184.738281 261.730469 187.214844 261.835938 188.972656 C 262.660156 202.582031 261.835938 216.003906 257.414062 229.03125 C 257.355469 229.207031 257.296875 229.386719 257.238281 229.566406 C 252.414062 243.992188 249.765625 244.910156 236.988281 236.816406 C 235.332031 235.761719 234.949219 234.226562 234.339844 232.6875 C 227.8125 215.960938 210.53125 203.777344 192.378906 203.613281 C 188.152344 203.570312 186.417969 202.09375 184.511719 198.382812 C 177.8125 185.371094 166.523438 179.058594 152.007812 178.875 C 148.085938 178.820312 146.046875 177.746094 144.21875 174.1875 C 138.5 163.011719 129.023438 156.988281 116.445312 157.335938 C 110.464844 157.503906 106.15625 156.453125 102.664062 151.3125 C 100.835938 148.625 97.8125 146.585938 94.996094 144.769531 C 92.28125 143.015625 92.570312 141.816406 94.449219 139.601562 C 108.996094 122.488281 127.230469 110.398438 147.371094 101.019531 C 163.464844 93.523438 180.0625 87.882812 198.121094 86.8125 C 223.078125 85.324219 244.304688 93.402344 262.625 109.867188 C 289.113281 133.65625 300.703125 164.558594 304.976562 198.90625 C 305.890625 206.554688 306.308594 214.226562 306.230469 221.925781 Z M 306.230469 221.925781 " fillOpacity="1" fillRule="nonzero"/><path fill="#fdfdfd" d="M 76.617188 146.214844 C 87.007812 146.742188 96.1875 151.085938 102.019531 161.019531 C 104.050781 164.488281 106.1875 165.375 110.242188 164.527344 C 123.996094 161.640625 135.691406 168.316406 139.957031 181.378906 C 141.242188 185.34375 142.914062 186.648438 147.214844 186.101562 C 163.179688 184.089844 175.175781 191.535156 180.492188 206.527344 C 181.816406 210.246094 184.1875 210.492188 187.515625 210.28125 C 201.199219 209.472656 212.402344 214.832031 221.722656 224.554688 C 225.320312 228.304688 227.945312 232.65625 228.644531 237.824219 C 229.132812 241.457031 230.910156 243.078125 234.40625 243.441406 C 238.050781 243.808594 241.273438 245.367188 244.273438 247.363281 C 254.183594 253.972656 254.367188 265.246094 244.425781 271.816406 C 241.488281 273.753906 240.140625 275.507812 239.894531 279.25 C 239.230469 289.164062 227.644531 295.367188 217.105469 291.777344 C 208.992188 289.007812 202.289062 283.75 195.429688 278.824219 C 170.238281 260.730469 144.921875 242.808594 117.171875 228.734375 C 99.082031 219.5625 80.667969 211.046875 62.445312 202.125 C 58.914062 200.398438 55.324219 198.597656 52.230469 196.226562 C 42.703125 188.921875 43.710938 176.28125 54.382812 170.941406 C 57.601562 169.332031 58.058594 167.558594 57.949219 164.425781 C 57.578125 153.65625 64.867188 146.351562 76.617188 146.214844 Z M 76.617188 146.214844 " fillOpacity="1" fillRule="nonzero"/><path fill="#fdfdfd" d="M 311.578125 297.285156 C 294.417969 297.203125 282.597656 285.136719 284.8125 269.171875 C 285.570312 263.695312 286.085938 256.851562 294.296875 256.238281 C 294.726562 256.203125 295.324219 255.628906 295.484375 255.183594 C 298.246094 247.449219 305.054688 247.503906 311.257812 247.6875 C 328.875 248.199219 342.007812 265.691406 336.679688 280.996094 C 333.140625 291.160156 323.621094 297.335938 311.578125 297.285156 Z M 311.578125 297.285156 " fillOpacity="1" fillRule="nonzero"/></svg>
    )
}

interface AvatarDisplayProps {
    user: Partial<User>;
    className?: string;
    showHat?: boolean;
}

export function AvatarDisplay({ user, className, showHat = false }: AvatarDisplayProps) {
    const avatarUrl = user.avatar;
    const name = user.name || '';
    
    if (!avatarUrl || typeof avatarUrl !== 'string') {
        return (
            <div className={cn("relative inline-block", className)}>
                <Avatar className="w-full h-full">
                    <AvatarFallback>{name.charAt(0).toUpperCase()}</AvatarFallback>
                </Avatar>
                {showHat && <SantaHat />}
            </div>
        );
    }
    
    const parts = avatarUrl.split('_');
    const id = parts[0];
    let letter, color;
    
    if (id === 'letter') {
        letter = parts[1];
        color = parts[2];
    } else {
        color = parts[1];
    }

    const Icon = shopAvatarMap.get(id)?.icon;

    if (Icon || letter) {
        return (
            <div className={cn("relative inline-block", className)}>
                <Avatar className="w-full h-full">
                    <div className="w-full h-full flex items-center justify-center" style={{ backgroundColor: color ? `#${color}` : '#737373' }}>
                        {letter ? (
                            <span className="font-bold text-4xl text-white">{letter}</span>
                        ) : Icon ? (
                            <Icon className="h-[60%] w-[60%] text-white" />
                        ) : (
                            <AvatarFallback>{name.substring(0, 2).toUpperCase()}</AvatarFallback>
                        )}
                    </div>
                </Avatar>
                {showHat && <SantaHat />}
            </div>
        );
    }
    
    // Fallback for original URL-based avatars from Google Sign In
    return (
        <div className={cn("relative inline-block", className)}>
            <Avatar className="w-full h-full">
                <AvatarImage src={avatarUrl} alt={name} />
                <AvatarFallback>{name.substring(0, 2).toUpperCase()}</AvatarFallback>
            </Avatar>
            {showHat && <SantaHat />}
        </div>
    );
}
